<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교통 현황</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-bottom: 80px;
        }
        
        /* 헤더 */
        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .header-icons {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .weather-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .weather-icon {
            font-size: 1.2rem;
        }
        
        .weather-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .weather-temp {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }
        
        .weather-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        .rain-warning {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }
        
        .rain-icon {
            font-size: 0.9rem;
        }
        
        .rain-text {
            font-weight: bold;
        }
        
        .rain-location {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }
        
        .bell-icon {
            font-size: 1.2rem;
        }
        
        /* 지연 예상 박스 */
        .delay-alert {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-left: 4px solid #2196f3;
        }
        
        .delay-icon {
            font-size: 1.5rem;
        }
        
        .delay-text {
            font-weight: bold;
            color: #1976d2;
        }
        
        /* 지하철 전용 헤더 */
        .subway-header {
            background: linear-gradient(135deg, #0052a4 0%, #00a5de 100%);
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .subway-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .subway-icon {
            font-size: 1.5rem;
        }
        
        /* 혼잡도 카드 */
        .congestion-section {
            margin: 1.5rem 1rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .congestion-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .congestion-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .congestion-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .circle-smooth { background-color: #4caf50; }
        .circle-normal { background-color: #ff9800; }
        .circle-congested { background-color: #f44336; }
        
        .congestion-percentage {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .congestion-label {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        
        /* 노선별 현황 */
        .lines-section {
            margin: 1.5rem 1rem;
        }
        
        .line-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .line-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .line-number {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .line-1 { background-color: #0052a4; }
        .line-2 { background-color: #00a84d; }
        .line-3 { background-color: #ef7c1c; }
        .line-4 { background-color: #00a5de; }
        .line-5 { background-color: #996cac; }
        .line-6 { background-color: #cd7c2f; }
        .line-7 { background-color: #747f00; }
        .line-8 { background-color: #e6186c; }
        .line-9 { background-color: #bdb092; }
        
        .line-details h3 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }
        
        .line-details p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .line-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-smooth { background-color: #4caf50; }
        .status-normal { background-color: #ff9800; }
        .status-congested { background-color: #f44336; }
        
        .status-text {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        /* 빠른 메뉴 */
        .quick-menu {
            margin: 1.5rem 1rem;
        }
        
        .quick-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .quick-menu-btn {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .quick-menu-btn:hover {
            transform: translateY(-2px);
        }
        
        .quick-menu-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .quick-menu-text {
            font-weight: bold;
            color: #333;
        }
        
        /* 최근 업데이트 */
        .recent-updates {
            margin: 1.5rem 1rem;
        }
        
        .update-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .update-time {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .update-message {
            font-weight: bold;
            color: #333;
        }
        
        /* 하단 네비게이션 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 0.8rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }
        
        .nav-item {
            text-align: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .nav-item.active {
            background-color: #2196f3;
            color: white;
        }
        
        .nav-item:not(.active) {
            color: #666;
        }
        
        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
        }
        
        .nav-text {
            font-size: 0.8rem;
        }
        
        /* 로딩 애니메이션 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 실시간 채팅 위젯 */
        .chat-widget {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 450px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .chat-header {
            background: #2196f3;
            color: white;
            padding: 1rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-weight: bold;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 250px;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .chat-message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        
        .chat-message.bot {
            background: #f5f5f5;
            margin-right: auto;
        }
        
        .chat-input {
            padding: 1rem;
            border-top: 1px solid #eee;
        }
        
        .chat-line-selector {
            margin-right: 1rem;
        }
        
        .chat-line-selector select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }
        
        .chat-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }
        
        .chat-line-info {
            font-weight: bold;
            color: #2196f3;
        }
        
        .chat-user-count {
            color: #666;
        }
        
        .chat-input {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-send-btn {
            padding: 0.5rem 1rem;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .chat-send-btn:hover {
            background: #1976d2;
        }
        
        .chat-message.line-specific {
            border-left: 3px solid #2196f3;
        }
        
        .chat-message.line-1 { border-left-color: #0052a4; }
        .chat-message.line-2 { border-left-color: #00a84d; }
        .chat-message.line-3 { border-left-color: #ef7c1c; }
        .chat-message.line-4 { border-left-color: #00a5de; }
        .chat-message.line-5 { border-left-color: #996cac; }
        .chat-message.line-6 { border-left-color: #cd7c2f; }
        .chat-message.line-7 { border-left-color: #747f00; }
        .chat-message.line-8 { border-left-color: #e6186c; }
        .chat-message.line-9 { border-left-color: #bdb092; }
        
        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .chat-sender {
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .chat-line-badge {
            background: #2196f3;
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .chat-timestamp {
            font-size: 0.7rem;
            color: #999;
        }
        
        /* 마케팅 배너 */
        .marketing-banner {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .marketing-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .marketing-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .marketing-content {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .marketing-coupon {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .marketing-btn {
            background: rgba(255,255,255,0.9);
            color: #ff6b6b;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .marketing-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .marketing-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 2;
        }
        
        .marketing-section {
            margin: 2rem 0;
        }
        
        .marketing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .marketing-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease;
        }
        
        .marketing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .marketing-card-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .marketing-card-content {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .marketing-card-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        .marketing-card-btn:hover {
            background: #1976d2;
        }
        
        /* 노선별 분석 페이지 */
        .analysis-page {
            display: none;
            padding: 1rem;
        }
        
        .analysis-header {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            text-align: center;
            color: white;
        }
        
        .line-analysis-card {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .line-chart {
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
            position: relative;
        }
        
        .chart-bar {
            background: #2196f3;
            margin: 0 2px;
            border-radius: 2px 2px 0 0;
            min-height: 20px;
            width: 20px;
            position: relative;
        }
        
        .chart-bar.smooth { background: #4caf50; }
        .chart-bar.normal { background: #ff9800; }
        .chart-bar.congested { background: #f44336; }
        
        /* 설정 페이지 */
        .settings-page {
            display: none;
            padding: 1rem;
        }
        
        .settings-header {
            background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            text-align: center;
            color: white;
        }
        
        .setting-item {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .setting-label {
            font-weight: bold;
            color: #333;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #2196f3;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        /* 알림 토스트 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.info { background: #2196f3; }
        
        /* 모달 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .route-result-modal .modal-content {
            max-width: 600px;
            text-align: left;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        .modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .modal-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        /* 인증 모달 스타일 */
        .auth-modal-content {
            max-width: 500px;
            width: 90%;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            font-weight: bold;
        }
        
        .auth-form h3 {
            margin-bottom: 1.5rem;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        .auth-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .auth-btn.primary:hover {
            background: #1976d2;
        }
        
        .auth-links {
            text-align: center;
            margin-top: 1rem;
        }
        
        .auth-links a {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .auth-links a:hover {
            text-decoration: underline;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* 사용자 정보 스타일 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-name {
            font-weight: bold;
            color: #333;
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .login-btn {
            padding: 0.5rem 1rem;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* 경로 검색 모달 */
        .route-modal-content {
            max-width: 600px;
        }
        
        .route-options {
            margin: 1rem 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        /* 즐겨찾기 모달 */
        .favorites-modal-content {
            max-width: 700px;
        }
        
        .favorites-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
        }
        
        .favorite-route {
            flex: 1;
        }
        
        .favorite-route-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .favorite-route-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .favorite-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .favorite-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .favorite-btn.use {
            background: #4caf50;
            color: white;
        }
        
        .favorite-btn.delete {
            background: #f44336;
            color: white;
        }
        
        /* 반응형 */
        @media (max-width: 480px) {
            .congestion-cards {
                gap: 0.5rem;
            }
            
            .congestion-card {
                padding: 1rem;
            }
            
            .congestion-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .congestion-percentage {
                font-size: 1.5rem;
            }
            
            .chat-widget {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .chat-fab {
                bottom: 80px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <div class="header-top">
            <div class="header-title">교통 현황</div>
            <div class="header-icons">
                <div class="weather-info" id="weather-info">
                    <div class="weather-icon" id="weather-icon">🌤️</div>
                    <div class="weather-details">
                        <div class="weather-temp" id="weather-temp">--°C</div>
                        <div class="weather-desc" id="weather-desc">날씨 로딩 중...</div>
                        <div class="rain-warning" id="rain-warning" style="display: none;">
                            <!-- 우천 경고는 JavaScript에서 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
                <div class="user-info" id="user-info" style="display: none;">
                    <span class="user-name" id="user-name">사용자</span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
                <button class="login-btn" id="login-btn" onclick="openAuthModal()">로그인</button>
                <span class="bell-icon">🔔</span>
            </div>
        </div>
    </div>
    
    <!-- 지연 예상 알림 -->
    <div class="delay-alert">
        <span class="delay-icon">☁️</span>
        <span class="delay-text">우천으로 인한 평균 5-10분 지연 예상</span>
    </div>
    
    <!-- 지하철 전용 헤더 -->
    <div class="subway-header">
        <div class="subway-title">
            <span class="subway-icon">🚇</span>
            <span>서울 지하철 실시간 현황</span>
        </div>
    </div>
    
    <!-- 지하철 실시간 현황 -->
    <div id="subway-content">
        <!-- 실시간 혼잡도 -->
        <div class="congestion-section">
            <h2 class="section-title">실시간 혼잡도</h2>
            <div class="congestion-cards" id="congestion-cards">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- 지하철 노선별 현황 -->
        <div class="lines-section">
            <h2 class="section-title">지하철 노선별 현황</h2>
            <div id="lines-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- 빠른 메뉴 -->
        <div class="quick-menu">
            <h2 class="section-title">빠른 메뉴</h2>
            <div class="quick-menu-grid">
                <div class="quick-menu-btn" onclick="openRouteSearch()">
                    <div class="quick-menu-icon">🚶</div>
                    <div class="quick-menu-text">경로 검색</div>
                </div>
                <div class="quick-menu-btn" onclick="openFavorites()">
                    <div class="quick-menu-icon">🔖</div>
                    <div class="quick-menu-text">즐겨찾기</div>
                </div>
                <div class="quick-menu-btn" onclick="refreshData()">
                    <div class="quick-menu-icon">🔄</div>
                    <div class="quick-menu-text">데이터 새로고침</div>
                </div>
                <div class="quick-menu-btn" onclick="openChat()">
                    <div class="quick-menu-icon">💬</div>
                    <div class="quick-menu-text">실시간 채팅</div>
                </div>
            </div>
        </div>
        
        <!-- 마케팅 섹션 -->
        <div class="marketing-section">
            <h2 class="section-title">🎁 스마트 혜택</h2>
            
            <!-- 혼잡 시간대 할인 배너 -->
            <div id="congestion-banner" class="marketing-banner" style="display: none;">
                <button class="marketing-close" onclick="closeMarketingBanner('congestion-banner')">&times;</button>
                <div class="marketing-title">🚇 혼잡 시간대 특별 할인!</div>
                <div class="marketing-content">지금 근처 카페에서 20% 할인 쿠폰을 받아보세요!</div>
                <div class="marketing-coupon">
                    <strong>COFFEE20</strong> - 아메리카노 20% 할인
                </div>
                <button class="marketing-btn" onclick="useCoupon('COFFEE20')">쿠폰 사용하기</button>
            </div>
            
            <!-- 마케팅 카드 그리드 -->
            <div class="marketing-grid">
                <div class="marketing-card">
                    <div class="marketing-card-title">☕ 근처 카페 할인</div>
                    <div class="marketing-card-content">
                        혼잡한 시간대에 근처 카페에서 휴식을 취하세요!<br>
                        실시간 할인 쿠폰을 제공합니다.
                    </div>
                    <button class="marketing-card-btn" onclick="showNearbyCafes()">근처 카페 보기</button>
                </div>
                
                <div class="marketing-card">
                    <div class="marketing-card-title">🚌 대안 교통수단</div>
                    <div class="marketing-card-content">
                        지하철 지연 시 빠른 대안을 찾아보세요!<br>
                        버스, 택시, 카셰어링 정보를 제공합니다.
                    </div>
                    <button class="marketing-card-btn" onclick="showAlternativeTransport()">대안 찾기</button>
                </div>
                
                <div class="marketing-card">
                    <div class="marketing-card-title">🛍️ 역세권 쇼핑</div>
                    <div class="marketing-card-content">
                        지하철역 근처 쇼핑몰과 상점 정보!<br>
                        특별 할인 정보도 함께 제공합니다.
                    </div>
                    <button class="marketing-card-btn" onclick="showNearbyShopping()">쇼핑 정보</button>
                </div>
                
                <div class="marketing-card">
                    <div class="marketing-card-title">🍽️ 맛집 추천</div>
                    <div class="marketing-card-content">
                        현재 위치 근처 맛집을 추천해드립니다!<br>
                        예약 가능한 식당 정보도 확인하세요.
                    </div>
                    <button class="marketing-card-btn" onclick="showNearbyRestaurants()">맛집 보기</button>
                </div>
            </div>
        </div>
        
        <!-- 최근 업데이트 -->
        <div class="recent-updates">
            <h2 class="section-title">최근 업데이트</h2>
            <div class="update-card">
                <div class="update-time" id="update-time">데이터 로딩 중...</div>
                <div class="update-message" id="update-message">서울 지하철 실시간 데이터를 수집하고 있습니다</div>
            </div>
        </div>
    </div>
    
    <!-- 노선별 분석 페이지 -->
    <div id="analysis-page" class="analysis-page">
        <div class="analysis-header">
            <h2>📈 노선별 상세 분석</h2>
            <p>각 노선의 혼잡도 패턴과 통계를 확인하세요</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>1호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line1-chart">
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar normal" style="height: 80px;"></div>
                <div class="chart-bar congested" style="height: 40px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar normal" style="height: 90px;"></div>
                <div class="chart-bar congested" style="height: 50px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 보통 (65%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 8-9시, 오후 6-7시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>2호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line2-chart">
                <div class="chart-bar smooth" style="height: 80px;"></div>
                <div class="chart-bar normal" style="height: 60px;"></div>
                <div class="chart-bar congested" style="height: 30px;"></div>
                <div class="chart-bar smooth" style="height: 85px;"></div>
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar congested" style="height: 35px;"></div>
                <div class="chart-bar smooth" style="height: 75px;"></div>
                <div class="chart-bar normal" style="height: 65px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 원활 (72%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 7-8시, 오후 5-6시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>3호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line3-chart">
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar congested" style="height: 90px;"></div>
                <div class="chart-bar congested" style="height: 95px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
                <div class="chart-bar congested" style="height: 85px;"></div>
                <div class="chart-bar congested" style="height: 100px;"></div>
                <div class="chart-bar normal" style="height: 80px;"></div>
                <div class="chart-bar congested" style="height: 90px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 혼잡 (85%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 8-9시, 오후 6-8시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>4호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line4-chart">
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 75px;"></div>
                <div class="chart-bar normal" style="height: 60px;"></div>
                <div class="chart-bar smooth" style="height: 80px;"></div>
                <div class="chart-bar normal" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 75px;"></div>
                <div class="chart-bar normal" style="height: 60px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 원활 (70%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 7-8시, 오후 5-6시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>5호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line5-chart">
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar normal" style="height: 80px;"></div>
                <div class="chart-bar normal" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 보통 (68%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 7-9시, 오후 6-7시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>6호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line6-chart">
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 75px;"></div>
                <div class="chart-bar normal" style="height: 55px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 원활 (65%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 8-9시, 오후 5-6시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>7호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line7-chart">
                <div class="chart-bar normal" style="height: 65px;"></div>
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar normal" style="height: 72px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 보통 (67%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 7-8시, 오후 6-7시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>8호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line8-chart">
                <div class="chart-bar smooth" style="height: 55px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 70px;"></div>
                <div class="chart-bar normal" style="height: 50px;"></div>
                <div class="chart-bar smooth" style="height: 60px;"></div>
                <div class="chart-bar smooth" style="height: 65px;"></div>
                <div class="chart-bar smooth" style="height: 55px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 원활 (60%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 8-9시, 오후 5-6시</p>
        </div>
        
        <div class="line-analysis-card">
            <h3>9호선 혼잡도 패턴</h3>
            <div class="line-chart" id="line9-chart">
                <div class="chart-bar normal" style="height: 70px;"></div>
                <div class="chart-bar congested" style="height: 85px;"></div>
                <div class="chart-bar congested" style="height: 90px;"></div>
                <div class="chart-bar normal" style="height: 75px;"></div>
                <div class="chart-bar congested" style="height: 80px;"></div>
                <div class="chart-bar congested" style="height: 88px;"></div>
                <div class="chart-bar normal" style="height: 72px;"></div>
                <div class="chart-bar congested" style="height: 82px;"></div>
            </div>
            <p><strong>평균 혼잡도:</strong> 혼잡 (81%)</p>
            <p><strong>최고 혼잡 시간:</strong> 오전 7-9시, 오후 6-8시</p>
        </div>
    </div>
    
    <!-- 설정 페이지 -->
    <div id="settings-page" class="settings-page">
        <div class="settings-header">
            <h2>⚙️ 설정</h2>
            <p>앱 설정을 관리하세요</p>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">실시간 알림</div>
            <div class="toggle-switch active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">지연 알림</div>
            <div class="toggle-switch active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">자동 새로고침</div>
            <div class="toggle-switch" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">다크 모드</div>
            <div class="toggle-switch" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">진동 알림</div>
            <div class="toggle-switch active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">위치 기반 알림</div>
            <div class="toggle-switch" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">앱 정보</div>
            <div style="color: #666; font-size: 0.9rem;">
                버전 1.0.0<br>
                서울교통공사 제공
            </div>
        </div>
    </div>
    
    <!-- 실시간 채팅 위젯 -->
    <button class="chat-fab" onclick="toggleChat()">💬</button>
    
    <div id="chat-widget" class="chat-widget">
        <div class="chat-header">
            <div class="chat-title">실시간 채팅</div>
            <div class="chat-line-selector">
                <select id="chat-line-selector" onchange="switchChatLine()">
                    <option value="all">전체</option>
                    <option value="1">1호선</option>
                    <option value="2">2호선</option>
                    <option value="3">3호선</option>
                    <option value="4">4호선</option>
                    <option value="5">5호선</option>
                    <option value="6">6호선</option>
                    <option value="7">7호선</option>
                    <option value="8">8호선</option>
                    <option value="9">9호선</option>
                </select>
            </div>
            <button class="chat-close" onclick="toggleChat()">×</button>
        </div>
        <div class="chat-info" id="chat-info">
            <span class="chat-line-info" id="chat-line-info">전체 채팅방</span>
            <span class="chat-user-count" id="chat-user-count">온라인: 0명</span>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- 사용자들끼리만 채팅 - 초기 메시지 제거 -->
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send-btn" onclick="sendChatMessage()">전송</button>
        </div>
    </div>
    
    <!-- 알림 토스트 -->
    <div id="toast" class="toast"></div>
    
    <!-- 로그인/회원가입 모달 -->
    <div id="auth-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <!-- X 버튼 추가 -->
            <button class="modal-close" onclick="closeAuthModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">로그인</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">회원가입</button>
            </div>
            
            <!-- 로그인 폼 -->
            <div id="login-form" class="auth-form">
                <h3>로그인</h3>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>이메일</label>
                        <input type="email" id="login-email" required placeholder="이메일을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>비밀번호</label>
                        <input type="password" id="login-password" required placeholder="비밀번호를 입력하세요">
                    </div>
                    <button type="submit" class="auth-btn primary">로그인</button>
                </form>
                <div class="auth-links">
                    <a href="#" onclick="showForgotPassword()">비밀번호를 잊으셨나요?</a>
                </div>
            </div>
            
            <!-- 회원가입 폼 -->
            <div id="register-form" class="auth-form" style="display: none;">
                <h3>회원가입</h3>
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>이름</label>
                        <input type="text" id="register-name" required placeholder="이름을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>이메일</label>
                        <input type="email" id="register-email" required placeholder="이메일을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>비밀번호</label>
                        <input type="password" id="register-password" required placeholder="비밀번호를 입력하세요" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>비밀번호 확인</label>
                        <input type="password" id="register-confirm-password" required placeholder="비밀번호를 다시 입력하세요">
                    </div>
                    <button type="submit" class="auth-btn primary">회원가입</button>
                </form>
            </div>
            
            <button class="modal-close" onclick="closeAuthModal()">×</button>
        </div>
    </div>
    
    <!-- 경로 검색 모달 -->
    <div id="route-modal" class="modal">
        <div class="modal-content route-modal-content">
            <div class="modal-title">경로 검색</div>
            <form onsubmit="searchRoute(event)">
                <div class="form-group">
                    <label>출발지</label>
                    <input type="text" id="departure-station" placeholder="출발역을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label>도착지</label>
                    <input type="text" id="arrival-station" placeholder="도착역을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label>출발 시간</label>
                    <input type="time" id="departure-time" value="">
                </div>
                <div class="route-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-to-favorites">
                        즐겨찾기에 저장
                    </label>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-btn primary">경로 검색</button>
                    <button type="button" class="modal-btn secondary" onclick="closeRouteModal()">취소</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 즐겨찾기 모달 -->
    <div id="favorites-modal" class="modal">
        <div class="modal-content favorites-modal-content">
            <div class="modal-title">즐겨찾기 경로</div>
            <div class="favorites-list" id="favorites-list">
                <!-- 즐겨찾기 목록이 여기에 동적으로 추가됩니다 -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeFavoritesModal()">닫기</button>
            </div>
        </div>
    </div>
    
    <!-- 모달 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">알림</div>
            <div id="modal-message"></div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeModal()">확인</button>
                <button class="modal-btn secondary" onclick="closeModal()">취소</button>
            </div>
        </div>
    </div>
    
    <!-- 하단 네비게이션 -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchNav('realtime')">
            <div class="nav-icon">🕐</div>
            <div class="nav-text">실시간 현황</div>
        </div>
        <div class="nav-item" onclick="switchNav('analysis')">
            <div class="nav-icon">📈</div>
            <div class="nav-text">노선별 분석</div>
        </div>
        <div class="nav-item" onclick="openChat()">
            <div class="nav-icon">💬</div>
            <div class="nav-text">실시간 채팅</div>
        </div>
        <div class="nav-item" onclick="switchNav('settings')">
            <div class="nav-icon">⚙️</div>
            <div class="nav-text">설정</div>
        </div>
    </div>
    
    <script>
        // 강제 캐시 무효화 및 실행 순서 보장
        console.log('🚇 서울 지하철 대시보드 로드됨 - ' + new Date().toLocaleTimeString());
        console.log('🔄 캐시 무효화 버전 v2 - ' + Date.now());
        
        // API 설정
        const SUBWAY_API_KEY = '78674e696f64686439354646555a65';
        const SUBWAY_BASE_URL = 'http://openapi.seoul.go.kr:8088';
        
        // 날씨 API 설정 (OpenWeatherMap 사용 예시)
        const WEATHER_API_KEY = 'AtzvOregQ2ic7zq3oHNoig'; // 실제 날씨 API 키
        const WEATHER_BASE_URL = 'https://api.openweathermap.org/data/2.5';
        
        // 날씨 데이터 가져오기 (눈과 비만 측정)
        async function fetchWeatherData() {
            try {
                const response = await fetch(`${WEATHER_BASE_URL}/weather?q=Seoul&appid=${WEATHER_API_KEY}&units=metric&lang=kr`);
                const data = await response.json();
                
                // 눈과 비 상태만 확인
                const weatherMain = data.weather[0].main;
                const isSnowing = weatherMain === 'Snow';
                const isRaining = weatherMain === 'Rain' || weatherMain === 'Drizzle';
                
                return {
                    temperature: Math.round(data.main.temp),
                    description: data.weather[0].description,
                    humidity: data.main.humidity,
                    rainProbability: data.rain ? (data.rain['1h'] || 0) : 0,
                    snowProbability: data.snow ? (data.snow['1h'] || 0) : 0,
                    icon: data.weather[0].icon,
                    isRaining: isRaining,
                    isSnowing: isSnowing,
                    precipitationType: getPrecipitationType(weatherMain, data.rain, data.snow),
                    precipitationIntensity: getPrecipitationIntensity(weatherMain, data.rain, data.snow)
                };
            } catch (error) {
                console.error('날씨 데이터 가져오기 실패:', error);
                return getSampleWeatherData();
            }
        }
        
        // 강수 타입 판단 (눈과 비만)
        function getPrecipitationType(weatherMain, rainData, snowData) {
            if (weatherMain === 'Snow') {
                return 'snow';
            } else if (weatherMain === 'Rain' || weatherMain === 'Drizzle') {
                return 'rain';
            }
            return 'none';
        }
        
        // 강수 강도 판단 (눈과 비만)
        function getPrecipitationIntensity(weatherMain, rainData, snowData) {
            if (weatherMain === 'Snow') {
                const snowAmount = snowData ? (snowData['1h'] || 0) : 0;
                if (snowAmount > 5) return 'heavy'; // 강한 눈
                if (snowAmount > 2) return 'moderate'; // 보통 눈
                return 'light'; // 가벼운 눈
            } else if (weatherMain === 'Rain') {
                const rainAmount = rainData ? (rainData['1h'] || 0) : 0;
                if (rainAmount > 10) return 'heavy'; // 강한 비
                if (rainAmount > 5) return 'moderate'; // 보통 비
                return 'light'; // 가벼운 비
            } else if (weatherMain === 'Drizzle') {
                return 'light'; // 이슬비
            }
            return 'none';
        }
        
        // 샘플 날씨 데이터
        function getSampleWeatherData() {
            const now = new Date();
            const hour = now.getHours();
            
            // 시간대별 날씨 시뮬레이션
            let weather = {
                temperature: 15,
                description: '맑음',
                humidity: 60,
                rainProbability: 0,
                icon: '01d',
                isRaining: false,
                rainIntensity: 'none'
            };
            
            // 오전/오후에 따라 온도 변화
            if (hour >= 6 && hour <= 12) {
                weather.temperature = 12 + Math.floor(Math.random() * 8);
            } else if (hour >= 13 && hour <= 18) {
                weather.temperature = 18 + Math.floor(Math.random() * 6);
            } else {
                weather.temperature = 8 + Math.floor(Math.random() * 8);
            }
            
            // 랜덤 날씨 조건
            const weatherConditions = [
                { description: '맑음', icon: '01d', isRaining: false, rainIntensity: 'none' },
                { description: '구름 조금', icon: '02d', isRaining: false, rainIntensity: 'none' },
                { description: '흐림', icon: '04d', isRaining: false, rainIntensity: 'none' },
                { description: '가벼운 비', icon: '10d', isRaining: true, rainIntensity: 'light' },
                { description: '보통 비', icon: '10d', isRaining: true, rainIntensity: 'moderate' },
                { description: '강한 비', icon: '10d', isRaining: true, rainIntensity: 'heavy' }
            ];
            
            const randomWeather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            weather.description = randomWeather.description;
            weather.icon = randomWeather.icon;
            weather.isRaining = randomWeather.isRaining;
            weather.rainIntensity = randomWeather.rainIntensity;
            weather.humidity = randomWeather.isRaining ? 80 + Math.floor(Math.random() * 20) : 50 + Math.floor(Math.random() * 30);
            weather.rainProbability = randomWeather.isRaining ? 60 + Math.floor(Math.random() * 40) : Math.floor(Math.random() * 20);
            
            return weather;
        }
        
        // 샘플 데이터 (API 실패 시 사용)
        const sampleData = {
            congestion_stats: { smooth: 42, normal: 35, congested: 23 },
            line_status: {
                '1': { status: 'normal', status_text: '보통', description: '서울역 ↔ 청량리 구간 지연', avg_passengers: 25000 },
                '2': { status: 'smooth', status_text: '원할', description: '정상 운행 중', avg_passengers: 18000 },
                '3': { status: 'congested', status_text: '혼잡', description: '강남 ↔ 교대 구간 심한 지연', avg_passengers: 38000 },
                '4': { status: 'smooth', status_text: '원할', description: '정상 운행 중', avg_passengers: 16000 },
                '5': { status: 'normal', status_text: '보통', description: '일산선 일부 구간 지연', avg_passengers: 22000 },
                '6': { status: 'smooth', status_text: '원할', description: '정상 운행 중', avg_passengers: 15000 },
                '7': { status: 'normal', status_text: '보통', description: '장암선 일부 지연', avg_passengers: 19000 },
                '8': { status: 'smooth', status_text: '원할', description: '정상 운행 중', avg_passengers: 14000 },
                '9': { status: 'normal', status_text: '보통', description: '9호선 일부 구간 지연', avg_passengers: 21000 }
            },
            stations: 338,
            passenger_data: 500
        };
        
        // 네비게이션 전환
        function switchNav(nav) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            // 모든 페이지 숨기기
            document.getElementById('subway-content').style.display = 'none';
            document.getElementById('analysis-page').style.display = 'none';
            document.getElementById('settings-page').style.display = 'none';
            
            // 선택된 페이지 보이기
            if (nav === 'realtime') {
                document.getElementById('subway-content').style.display = 'block';
            } else if (nav === 'analysis') {
                document.getElementById('analysis-page').style.display = 'block';
            } else if (nav === 'settings') {
                document.getElementById('settings-page').style.display = 'block';
            }
            
            console.log('네비게이션:', nav);
        }
        
        // 빠른 메뉴 기능
        function openRouteSearch() {
            console.log('경로 검색 버튼 클릭됨');
            const modal = document.getElementById('route-modal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('경로 검색 모달 열림');
            } else {
                console.error('route-modal 요소를 찾을 수 없음');
                alert('경로 검색 기능을 준비 중입니다! 🚶‍♂️');
            }
        }
        
        function openFavorites() {
            console.log('즐겨찾기 버튼 클릭됨');
            const modal = document.getElementById('favorites-modal');
            if (modal) {
                modal.style.display = 'flex';
                loadFavorites();
                console.log('즐겨찾기 모달 열림');
            } else {
                console.error('favorites-modal 요소를 찾을 수 없음');
                alert('즐겨찾기 기능을 준비 중입니다! 🔖');
            }
        }
        
        function openChat() {
            toggleChat();
        }
        
        // 채팅 위젯 토글
        function toggleChat() {
            const chatWidget = document.getElementById('chat-widget');
            const chatFab = document.querySelector('.chat-fab');
            
            if (chatWidget.style.display === 'none' || chatWidget.style.display === '') {
                chatWidget.style.display = 'flex';
                chatFab.style.display = 'none';
                document.getElementById('chat-input').focus();
            } else {
                chatWidget.style.display = 'none';
                chatFab.style.display = 'block';
            }
        }
        
        // 채팅 메시지 전송
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                // 사용자 메시지 추가 (노선별 채팅 지원)
                const user = JSON.parse(localStorage.getItem('user'));
                const senderName = user ? user.name : '익명';
                addChatMessage(message, senderName, currentChatLine);
                input.value = '';
                
                // 봇 응답 제거 - 사용자들끼리만 채팅
                console.log('사용자 메시지 전송:', message, '발신자:', senderName, '노선:', currentChatLine);
            }
        }
        
        // 기존 addChatMessage 함수는 위에서 새로운 버전으로 교체됨
        
        function getBotResponse(userMessage) {
            const responses = [
                '네, 도움이 필요하시면 언제든 말씀해 주세요! 😊',
                '지하철 관련 문의사항이 있으시면 상세히 알려드릴게요.',
                '실시간 교통 정보는 30초마다 업데이트됩니다.',
                '혼잡도가 높은 시간대는 오전 7-9시, 오후 5-7시입니다.',
                '더 자세한 정보가 필요하시면 설정에서 알림을 켜주세요.',
                '서울 지하철은 1-4호선이 가장 주요 노선입니다.',
                '지연 정보는 실시간으로 업데이트되니 참고해 주세요.'
            ];
            
            // 키워드 기반 응답
            if (userMessage.includes('혼잡') || userMessage.includes('지연')) {
                return '현재 3호선이 가장 혼잡한 상태입니다. 다른 노선을 이용해보세요.';
            } else if (userMessage.includes('시간') || userMessage.includes('언제')) {
                return '출퇴근 시간대(오전 7-9시, 오후 5-7시)에 가장 혼잡합니다.';
            } else if (userMessage.includes('노선') || userMessage.includes('호선')) {
                return '1-4호선이 주요 노선이며, 2호선과 4호선이 상대적으로 원활합니다.';
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // 캐시 버스팅을 위한 타임스탬프
        console.log('파일 로드 시간:', new Date().toLocaleString('ko-KR'));
        console.log('캐시 버스팅 활성화됨');
        
        // 노선별 채팅 기능
        let currentChatLine = 'all';
        let chatMessages = {
            'all': [],
            '1': [], '2': [], '3': [], '4': [], '5': [], '6': [], '7': [], '8': [], '9': []
        };
        
        function switchChatLine() {
            const selector = document.getElementById('chat-line-selector');
            currentChatLine = selector.value;
            
            const lineInfo = document.getElementById('chat-line-info');
            const userCount = document.getElementById('chat-user-count');
            
            if (currentChatLine === 'all') {
                lineInfo.textContent = '전체 채팅방';
                userCount.textContent = '온라인: ' + getRandomUserCount() + '명';
            } else {
                lineInfo.textContent = `${currentChatLine}호선 채팅방`;
                userCount.textContent = '온라인: ' + getRandomUserCount() + '명';
            }
            
            loadChatMessages();
        }
        
        function getRandomUserCount() {
            return Math.floor(Math.random() * 50) + 10;
        }
        
        function loadChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = chatMessages[currentChatLine];
            
            messagesContainer.innerHTML = '';
            
            // 환영 메시지 제거 - 사용자들끼리만 채팅
            if (messages.length === 0) {
                console.log('채팅방 초기화:', currentChatLine);
            } else {
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${message.sender === 'bot' ? 'bot' : 'user'} ${message.line ? 'line-specific line-' + message.line : ''}`;
                    
                    if (message.sender !== 'bot') {
                        messageDiv.innerHTML = `
                            <div class="chat-message-header">
                                <span class="chat-sender">${message.sender}</span>
                                <span class="chat-line-badge">${message.line}호선</span>
                                <span class="chat-timestamp">${message.timestamp}</span>
                            </div>
                            <div class="chat-content">${message.content}</div>
                        `;
                    } else {
                        messageDiv.innerHTML = message.content;
                    }
                    
                    messagesContainer.appendChild(messageDiv);
                });
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addChatMessage(message, sender, line = null) {
            const messageObj = {
                content: message,
                sender: sender,
                line: line,
                timestamp: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                id: Date.now()
            };
            
            // 현재 선택된 채팅방에 메시지 추가
            chatMessages[currentChatLine].push(messageObj);
            
            // 전체 채팅방에도 추가 (전체가 아닌 경우)
            if (currentChatLine !== 'all' && line) {
                chatMessages['all'].push(messageObj);
            }
            
            loadChatMessages();
        }
        
        // 설정 토글
        function toggleSetting(element) {
            element.classList.toggle('active');
            const settingName = element.parentElement.querySelector('.setting-label').textContent;
            showToast(`${settingName} ${element.classList.contains('active') ? '켜짐' : '꺼짐'}`, 'info');
        }
        
        // 토스트 알림
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // 모달 표시
        function showModal(title, message) {
            console.log('showModal 호출됨:', title, message);
            
            // 기존 방식으로 모달 표시
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modal = document.getElementById('modal');
            
            if (modalTitle && modalMessage && modal) {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modal.style.display = 'flex';
                console.log('모달 표시 완료');
            } else {
                console.error('모달 요소를 찾을 수 없습니다');
                console.log('modalTitle:', modalTitle);
                console.log('modalMessage:', modalMessage);
                console.log('modal:', modal);
            }
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // 인증 관련 함수들
        function openAuthModal() {
            console.log('로그인 모달 열기');
            document.getElementById('auth-modal').style.display = 'flex';
            
            // ESC 키로 닫기 기능 추가
            document.addEventListener('keydown', handleEscapeKey);
            
            // 배경 클릭으로 닫기 기능 추가
            document.getElementById('auth-modal').addEventListener('click', handleBackgroundClick);
        }
        
        function closeAuthModal() {
            console.log('로그인 모달 닫기');
            document.getElementById('auth-modal').style.display = 'none';
            
            // 이벤트 리스너 제거
            document.removeEventListener('keydown', handleEscapeKey);
        }
        
        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                console.log('ESC 키로 모달 닫기');
                closeAuthModal();
            }
        }
        
        function handleBackgroundClick(event) {
            // 배경을 클릭했을 때만 닫기 (모달 내용 클릭 시에는 닫지 않음)
            if (event.target === event.currentTarget) {
                console.log('배경 클릭으로 모달 닫기');
                closeAuthModal();
            }
        }
        
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }
        
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // 간단한 로그인 시뮬레이션
            if (email && password) {
                const user = {
                    name: email.split('@')[0],
                    email: email,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('user', JSON.stringify(user));
                updateUserUI(user);
                closeAuthModal();
                showToast('로그인 성공!', 'success');
            } else {
                showToast('이메일과 비밀번호를 입력해주세요.', 'error');
            }
        }
        
        function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (password !== confirmPassword) {
                showToast('비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            
            if (name && email && password) {
                const user = {
                    name: name,
                    email: email,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('user', JSON.stringify(user));
                updateUserUI(user);
                closeAuthModal();
                showToast('회원가입 성공!', 'success');
            } else {
                showToast('모든 필드를 입력해주세요.', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('favorites');
            updateUserUI(null);
            showToast('로그아웃되었습니다.', 'info');
        }
        
        function updateUserUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            
            if (user) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = user.name;
            } else {
                loginBtn.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        function showForgotPassword() {
            showModal('비밀번호 찾기', '비밀번호 찾기 기능은 준비 중입니다.');
        }
        
        // 경로 검색 관련 함수들
        function openRouteModal() {
            document.getElementById('route-modal').style.display = 'flex';
            // 현재 시간으로 기본값 설정
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            document.getElementById('departure-time').value = timeString;
        }
        
        function closeRouteModal() {
            document.getElementById('route-modal').style.display = 'none';
        }
        
        function searchRoute(event) {
            event.preventDefault();
            console.log('=== 경로 검색 시작 ===');
            console.log('타임스탬프:', new Date().toLocaleString('ko-KR'));
            
            const departure = document.getElementById('departure-station').value;
            const arrival = document.getElementById('arrival-station').value;
            const time = document.getElementById('departure-time').value;
            const saveToFavorites = document.getElementById('save-to-favorites').checked;
            
            console.log('입력값 확인:');
            console.log('- 출발지:', departure);
            console.log('- 도착지:', arrival);
            console.log('- 시간:', time);
            console.log('- 즐겨찾기:', saveToFavorites);
            
            if (!departure || !arrival) {
                alert('출발지와 도착지를 모두 입력해주세요.');
                return;
            }
            
            // 실제 경로 생성 함수 호출
            console.log('generateRoute 함수 호출 시작');
            const route = generateRoute(departure, arrival, time);
            console.log('generateRoute 함수 호출 완료');
            console.log('생성된 route 객체:', route);
            
            if (saveToFavorites) {
                saveFavoriteRoute(route);
            }
            
            console.log('showRouteResult 함수 호출 전');
            // showRouteResult 함수 호출
            showRouteResult(route);
            console.log('showRouteResult 함수 호출 후');
            
            closeRouteModal();
            console.log('=== 경로 검색 완료 ===');
        }
        
        
        function generateRoute(departure, arrival, time) {
            // 실제 서울 지하철 역 데이터 기반 경로 생성
            const stations = {
                '강남': { line: '2호선', code: '222' },
                '서울역': { line: '1호선', code: '133' },
                '홍대입구': { line: '2호선', code: '239' },
                '신촌': { line: '2호선', code: '240' },
                '이대': { line: '2호선', code: '241' },
                '아현': { line: '2호선', code: '242' },
                '충정로': { line: '2호선', code: '243' },
                '시청': { line: '1호선', code: '132' },
                '종각': { line: '1호선', code: '131' },
                '을지로입구': { line: '2호선', code: '202' },
                '을지로3가': { line: '2호선', code: '203' },
                '을지로4가': { line: '2호선', code: '204' },
                '동대문역사문화공원': { line: '2호선', code: '205' },
                '신당': { line: '2호선', code: '206' },
                '상왕십리': { line: '2호선', code: '207' },
                '왕십리': { line: '2호선', code: '208' },
                '한양대': { line: '2호선', code: '209' },
                '뚝섬': { line: '2호선', code: '210' },
                '성수': { line: '2호선', code: '211' },
                '건대입구': { line: '2호선', code: '212' },
                '구의': { line: '2호선', code: '213' },
                '광나루': { line: '2호선', code: '214' },
                '천호': { line: '2호선', code: '215' },
                '강동': { line: '2호선', code: '216' },
                '올림픽공원': { line: '2호선', code: '217' },
                '방이': { line: '2호선', code: '218' },
                '송파': { line: '2호선', code: '219' },
                '석촌': { line: '2호선', code: '220' },
                '잠실': { line: '2호선', code: '221' },
                '문정': { line: '2호선', code: '223' },
                '장지': { line: '2호선', code: '224' },
                '복정': { line: '2호선', code: '225' },
                '산성': { line: '2호선', code: '226' },
                '남한산성입구': { line: '2호선', code: '227' },
                '단대오거리': { line: '2호선', code: '228' },
                '신흥': { line: '2호선', code: '229' },
                '수진': { line: '2호선', code: '230' },
                '모란': { line: '2호선', code: '231' },
                '수유': { line: '4호선', code: '413' },
                '미아': { line: '4호선', code: '414' },
                '미아사거리': { line: '4호선', code: '415' },
                '길음': { line: '4호선', code: '416' },
                '성신여대입구': { line: '4호선', code: '417' },
                '한성대입구': { line: '4호선', code: '418' },
                '혜화': { line: '4호선', code: '419' },
                '동대문': { line: '4호선', code: '420' },
                '동대문역사문화공원': { line: '4호선', code: '421' },
                '충무로': { line: '4호선', code: '422' },
                '명동': { line: '4호선', code: '423' },
                '회현': { line: '4호선', code: '424' },
                '서울역': { line: '4호선', code: '425' },
                '숙대입구': { line: '4호선', code: '426' },
                '삼각지': { line: '4호선', code: '427' },
                '신용산': { line: '4호선', code: '428' },
                '이촌': { line: '4호선', code: '429' },
                '동작': { line: '4호선', code: '430' },
                '총신대입구': { line: '4호선', code: '431' },
                '사당': { line: '4호선', code: '432' },
                '남태령': { line: '4호선', code: '433' },
                '선바위': { line: '4호선', code: '434' },
                '경마공원': { line: '4호선', code: '435' },
                '대공원': { line: '4호선', code: '436' },
                '과천': { line: '4호선', code: '437' },
                '정부과천청사': { line: '4호선', code: '438' },
                '인덕원': { line: '4호선', code: '439' },
                '평촌': { line: '4호선', code: '440' },
                '범계': { line: '4호선', code: '441' },
                '금정': { line: '4호선', code: '442' },
                '산본': { line: '4호선', code: '443' },
                '수리산': { line: '4호선', code: '444' },
                '대야미': { line: '4호선', code: '445' },
                '반월': { line: '4호선', code: '446' },
                '상록수': { line: '4호선', code: '447' },
                '한대앞': { line: '4호선', code: '448' },
                '중앙': { line: '4호선', code: '449' },
                '고잔': { line: '4호선', code: '450' },
                '초지': { line: '4호선', code: '451' },
                '안산': { line: '4호선', code: '452' },
                '신길온천': { line: '4호선', code: '453' },
                '정왕': { line: '4호선', code: '454' },
                '오이도': { line: '4호선', code: '455' }
            };
            
            // 출발지와 도착지가 실제 역인지 확인
            const departureStation = stations[departure];
            const arrivalStation = stations[arrival];
            
            console.log('출발역 정보:', departureStation);
            console.log('도착역 정보:', arrivalStation);
            
            // 실제 역이 아닌 경우 처리
            if (!departureStation || !arrivalStation) {
                console.log('실제 역이 아닙니다. 기본 경로 생성');
                const route = {
                    id: Date.now(),
                    name: `${departure} → ${arrival}`,
                    departure: departure,
                    arrival: arrival,
                    time: time,
                    totalTime: Math.floor(Math.random() * 30) + 15,
                    transfers: 0,
                    steps: [{
                        line: '1호선',
                        stations: [departure, arrival],
                        time: Math.floor(Math.random() * 30) + 15
                    }],
                    congestionLevel: '원활',
                    fare: 1400,
                    createdAt: new Date().toISOString()
                };
                return route;
            }
            
            // 강제 다중 노선 경로 생성 (확실한 버전)
            console.log('🚇 강제 다중 노선 경로 생성 시작');
            console.log('출발역:', departure, departureStation.line);
            console.log('도착역:', arrival, arrivalStation.line);
            
            // 항상 2개 구간으로 강제 생성
            const transferStations = ['동대문역사문화공원', '시청', '종각', '을지로3가', '강남', '신촌'];
            const transferStation = transferStations[Math.floor(Math.random() * transferStations.length)];
            
            console.log('선택된 환승역:', transferStation);
            
            const routeSteps = [
                {
                    line: departureStation.line,
                    stations: [departure, transferStation],
                    time: Math.floor(Math.random() * 20) + 10
                },
                {
                    line: arrivalStation.line,
                    stations: [transferStation, arrival],
                    time: Math.floor(Math.random() * 20) + 10
                }
            ];
            
            const transfers = 1;
            const totalTime = routeSteps[0].time + routeSteps[1].time + 5;
            
            console.log('🚇 강제 생성된 경로 단계:', routeSteps);
            console.log('🚇 경로 생성 완료');
            
            // AI 기반 혼잡도 예측 함수
        function predictCongestionWithAI(hour, dayOfWeek, weather, line, station) {
            console.log('🤖 AI 혼잡도 예측 시작');
            console.log('입력 데이터:', { hour, dayOfWeek, weather, line, station });
            
            // 간단한 AI 모델 시뮬레이션 (실제로는 머신러닝 모델 사용)
            let baseCongestion = 0.3; // 기본 혼잡도
            
            // 시간대별 가중치
            const timeWeights = {
                'rush_morning': [7, 8, 9],    // 러시아워 (오전)
                'rush_evening': [18, 19, 20], // 러시아워 (오후)
                'normal': [10, 11, 14, 15, 16, 17], // 일반시간
                'low': [0, 1, 2, 3, 4, 5, 6, 21, 22, 23] // 저조시간
            };
            
            if (timeWeights.rush_morning.includes(hour) || timeWeights.rush_evening.includes(hour)) {
                baseCongestion += 0.4;
            } else if (timeWeights.normal.includes(hour)) {
                baseCongestion += 0.2;
            }
            
            // 요일별 가중치
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // 평일
                baseCongestion += 0.2;
            }
            
            // 날씨별 가중치
            const weatherWeights = {
                'rain': 0.15,
                'snow': 0.2,
                'sunny': 0.05,
                'cloudy': 0.0
            };
            baseCongestion += weatherWeights[weather] || 0;
            
            // 노선별 가중치
            const lineWeights = {
                '1호선': 0.1,
                '2호선': 0.2,  // 가장 혼잡한 노선
                '3호선': 0.15,
                '4호선': 0.1,
                '5호선': 0.05,
                '6호선': 0.05,
                '7호선': 0.1,
                '8호선': 0.05,
                '9호선': 0.15
            };
            baseCongestion += lineWeights[line] || 0;
            
            // 역별 가중치 (주요 환승역)
            const stationWeights = {
                '강남': 0.2,
                '신촌': 0.15,
                '시청': 0.15,
                '종각': 0.15,
                '을지로3가': 0.1,
                '동대문역사문화공원': 0.1,
                '왕십리': 0.1,
                '건대입구': 0.15,
                '잠실': 0.1
            };
            baseCongestion += stationWeights[station] || 0;
            
            // 랜덤 노이즈 추가 (실제 환경 시뮬레이션)
            const noise = (Math.random() - 0.5) * 0.1;
            baseCongestion += noise;
            
            // 0-1 범위로 제한
            baseCongestion = Math.max(0, Math.min(1, baseCongestion));
            
            // 혼잡도 레벨 변환
            let congestionLevel;
            if (baseCongestion >= 0.7) {
                congestionLevel = '혼잡';
            } else if (baseCongestion >= 0.4) {
                congestionLevel = '보통';
            } else {
                congestionLevel = '원활';
            }
            
            console.log('🤖 AI 예측 결과:', {
                congestionScore: baseCongestion.toFixed(3),
                congestionLevel: congestionLevel,
                confidence: '높음'
            });
            
            return {
                score: baseCongestion,
                level: congestionLevel,
                confidence: '높음',
                factors: {
                    time: hour,
                    weather: weather,
                    line: line,
                    station: station
                }
            };
        }
            // AI 기반 혼잡도 예측 사용
            const currentHour = new Date().getHours();
            const currentDay = new Date().getDay(); // 0=일요일, 1=월요일, ...
            const currentWeather = weatherData ? weatherData.weatherMain.toLowerCase() : 'sunny';
            
            // AI로 혼잡도 예측
            const aiPrediction = predictCongestionWithAI(
                currentHour, 
                currentDay, 
                currentWeather, 
                departureStation.line, 
                departure
            );
            
            const congestionLevel = aiPrediction.level;
            
            const route = {
                id: Date.now(),
                name: `${departure} → ${arrival}`,
                departure: departure,
                arrival: arrival,
                time: time,
                totalTime: totalTime,
                transfers: transfers,
                steps: routeSteps,
                congestionLevel: congestionLevel,
                fare: calculateFare(totalTime, transfers),
                createdAt: new Date().toISOString()
            };
            
            console.log('생성된 경로:', route);
            console.log('경로 단계 수:', routeSteps.length);
            console.log('경로 단계들:', routeSteps);
            
            return route;
        }
        
        function calculateFare(totalTime, transfers) {
            // 서울 지하철 요금 계산 (기본요금 + 거리요금)
            let fare = 1400; // 기본요금
            
            if (totalTime > 30) {
                fare += 100; // 10km 초과
            }
            if (totalTime > 50) {
                fare += 100; // 20km 초과
            }
            if (transfers > 0) {
                fare += transfers * 100; // 환승할 때마다 추가요금
            }
            
            return fare;
        }
        
        function showRouteResult(route) {
            console.log('showRouteResult 호출됨:', route);
            console.log('route.steps:', route.steps);
            console.log('route.steps.length:', route.steps.length);
            
            // 경로 상세 정보 생성
            let routeDetails = '';
            route.steps.forEach((step, index) => {
                console.log(`단계 ${index}:`, step);
                routeDetails += `
                    <div style="padding: 0.8rem; border-left: 4px solid #2196f3; background: #f8f9fa; margin-bottom: 0.5rem; border-radius: 4px;">
                        <div style="font-weight: bold; color: #2196f3; margin-bottom: 0.3rem;">
                            ${step.line} ${index > 0 ? '(환승)' : ''}
                        </div>
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.3rem;">
                            ${step.stations.join(' → ')}
                        </div>
                        <div style="color: #999; font-size: 0.8rem;">
                            소요시간: ${step.time}분
                        </div>
                    </div>
                `;
            });
            
            console.log('생성된 routeDetails:', routeDetails);
            
            const message = `
                <div style="text-align: left; padding: 1rem;">
                    <h3 style="color: #2196f3; margin-bottom: 1rem;">🚇 ${route.name}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1976d2;">${route.totalTime}분</div>
                            <div style="font-size: 0.9rem; color: #666;">소요시간</div>
                        </div>
                        <div style="background: ${route.congestionLevel === '혼잡' ? '#ffebee' : route.congestionLevel === '보통' ? '#fff8e1' : '#e8f5e8'}; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${route.congestionLevel === '혼잡' ? '#d32f2f' : route.congestionLevel === '보통' ? '#f57c00' : '#2e7d32'};">${route.congestionLevel}</div>
                            <div style="font-size: 0.9rem; color: #666;">혼잡도</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <h4 style="color: #1976d2; margin-bottom: 0.5rem;">🚉 경로 상세</h4>
                        ${routeDetails}
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button onclick="alert('즐겨찾기에 저장되었습니다!')" style="flex: 1; background: #ff9800; color: white; border: none; padding: 0.8rem; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ⭐ 즐겨찾기
                        </button>
                        <button onclick="alert('경로 정보가 복사되었습니다!')" style="flex: 1; background: #4caf50; color: white; border: none; padding: 0.8rem; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            📤 공유하기
                        </button>
                    </div>
                    
                    <div style="background: #e1f5fe; padding: 0.8rem; border-radius: 8px; font-size: 0.85rem; color: #0277bd; margin-top: 1rem;">
                        <div>💡 실시간 정보 기준</div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>검색 시간: ${new Date().toLocaleTimeString('ko-KR')}</span>
                            <span>업데이트: 방금 전</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('경로 검색 결과', message);
        }
        
        // 즐겨찾기에 경로 저장
        function saveRouteToFavorites(routeName, departure, arrival) {
            const favorites = JSON.parse(localStorage.getItem('favoriteRoutes') || '[]');
            const newRoute = {
                id: Date.now(),
                name: routeName,
                departure: departure,
                arrival: arrival,
                savedAt: new Date().toLocaleString('ko-KR')
            };
            
            // 중복 체크
            const exists = favorites.some(route => 
                route.departure === departure && route.arrival === arrival
            );
            
            if (exists) {
                alert('이미 즐겨찾기에 저장된 경로입니다.');
                return;
            }
            
            favorites.push(newRoute);
            localStorage.setItem('favoriteRoutes', JSON.stringify(favorites));
            alert('즐겨찾기에 저장되었습니다!');
        }
        
        // 경로 공유하기
        function shareRoute(routeName) {
            const shareText = `🚇 ${routeName} 경로를 서울 지하철 앱에서 확인해보세요!`;
            
            if (navigator.share) {
                navigator.share({
                    title: '서울 지하철 경로',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // 클립보드에 복사
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('경로 정보가 클립보드에 복사되었습니다!');
                }).catch(() => {
                    alert('공유 기능을 사용할 수 없습니다.');
                });
            }
        }
        
        // 즐겨찾기 관련 함수들
        function openFavoritesModal() {
            document.getElementById('favorites-modal').style.display = 'flex';
            loadFavorites();
        }
        
        function closeFavoritesModal() {
            document.getElementById('favorites-modal').style.display = 'none';
        }
        
        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const favoritesList = document.getElementById('favorites-list');
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">저장된 즐겨찾기가 없습니다.</p>';
                return;
            }
            
            favoritesList.innerHTML = favorites.map(favorite => `
                <div class="favorite-item">
                    <div class="favorite-route">
                        <div class="favorite-route-name">${favorite.name}</div>
                        <div class="favorite-route-details">
                            소요시간: ${favorite.totalTime}분 | 환승: ${favorite.transfers}회
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="favorite-btn use" onclick="useFavoriteRoute('${favorite.id}')">사용</button>
                        <button class="favorite-btn delete" onclick="deleteFavoriteRoute('${favorite.id}')">삭제</button>
                    </div>
                </div>
            `).join('');
        }
        
        function saveFavoriteRoute(route) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favorites.push(route);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            showToast('즐겨찾기에 저장되었습니다!', 'success');
        }
        
        function useFavoriteRoute(routeId) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const favorite = favorites.find(f => f.id == routeId);
            
            if (favorite) {
                showRouteResult(favorite);
            }
        }
        
        function deleteFavoriteRoute(routeId) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const filteredFavorites = favorites.filter(f => f.id != routeId);
            localStorage.setItem('favorites', JSON.stringify(filteredFavorites));
            loadFavorites();
            showToast('즐겨찾기가 삭제되었습니다.', 'info');
        }
        
        // 날씨 정보 업데이트
        // 사용자 위치 및 날씨 기반 우천 경고
        let userLocation = null;
        let weatherData = null;
        
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                console.log('📍 위치 정보 요청 시작');
                
                if (!navigator.geolocation) {
                    console.log('📍 Geolocation API 지원 안함 - 서울 기본값 사용');
                    userLocation = { lat: 37.5665, lon: 126.9780, city: 'Seoul' };
                    resolve(userLocation);
                    return;
                }
                
                // 타임아웃 설정 (10초)
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5분 캐시
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            city: 'Current Location'
                        };
                        console.log('📍 위치 정보 획득 성공:', userLocation);
                        resolve(userLocation);
                    },
                    (error) => {
                        console.log('📍 위치 정보 획득 실패:', error.message);
                        console.log('📍 서울 기본값 사용');
                        userLocation = { lat: 37.5665, lon: 126.9780, city: 'Seoul' };
                        resolve(userLocation);
                    },
                    options
                );
            });
        }
        
        async function fetchLocationBasedWeather() {
            try {
                console.log('🌤️ 위치 기반 날씨 데이터 요청 시작');
                
                if (!userLocation) {
                    console.log('📍 사용자 위치 없음 - 위치 정보 요청');
                    await getUserLocation();
                }
                
                console.log('📍 사용자 위치:', userLocation);
                
                const apiKey = 'AtzvOregQ2ic7zq3oHNoig';
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${userLocation.lat}&lon=${userLocation.lon}&appid=${apiKey}&units=metric&lang=kr`;
                
                console.log('🌐 API URL:', url);
                
                const response = await fetch(url);
                console.log('📡 API 응답 상태:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API 응답 오류: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 API 응답 데이터:', data);
                
                weatherData = {
                    temperature: Math.round(data.main.temp),
                    description: data.weather[0].description,
                    humidity: data.main.humidity,
                    rain: data.rain ? data.rain['1h'] || 0 : 0,
                    snow: data.snow ? data.snow['1h'] || 0 : 0,
                    weatherMain: data.weather[0].main,
                    city: data.name,
                    icon: data.weather[0].icon
                };
                
                console.log('✅ 위치 기반 날씨 데이터 성공:', weatherData);
                return weatherData;
            } catch (error) {
                console.error('❌ 날씨 데이터 가져오기 실패:', error);
                
                // 폴백: 서울 날씨 데이터
                console.log('🔄 서울 날씨 데이터로 폴백 시도');
                try {
                    const fallbackUrl = `https://api.openweathermap.org/data/2.5/weather?q=Seoul&appid=${apiKey}&units=metric&lang=kr`;
                    const fallbackResponse = await fetch(fallbackUrl);
                    const fallbackData = await fallbackResponse.json();
                    
                    weatherData = {
                        temperature: Math.round(fallbackData.main.temp),
                        description: fallbackData.weather[0].description,
                        humidity: fallbackData.main.humidity,
                        rain: fallbackData.rain ? fallbackData.rain['1h'] || 0 : 0,
                        snow: fallbackData.snow ? fallbackData.snow['1h'] || 0 : 0,
                        weatherMain: fallbackData.weather[0].main,
                        city: 'Seoul',
                        icon: fallbackData.weather[0].icon
                    };
                    
                    console.log('✅ 서울 폴백 날씨 데이터 성공:', weatherData);
                    return weatherData;
                } catch (fallbackError) {
                    console.error('❌ 폴백 날씨 데이터도 실패:', fallbackError);
                    return null;
                }
            }
        }
        
        function checkRainSnowWarning() {
            if (!weatherData) return false;
            
            // 비나 눈이 오는 경우 체크
            const isRaining = weatherData.rain > 0 || weatherData.weatherMain === 'Rain';
            const isSnowing = weatherData.snow > 0 || weatherData.weatherMain === 'Snow';
            const isDrizzle = weatherData.weatherMain === 'Drizzle';
            
            return isRaining || isSnowing || isDrizzle;
        }
        
        function showRainWarning() {
            const warningBanner = document.getElementById('rain-warning');
            
            console.log('우천 경고 체크 시작');
            console.log('weatherData:', weatherData);
            console.log('checkRainSnowWarning():', checkRainSnowWarning());
            
            if (warningBanner && weatherData && checkRainSnowWarning()) {
                const rainIntensity = weatherData.rain > 0 ? weatherData.rain : 0;
                const snowIntensity = weatherData.snow > 0 ? weatherData.snow : 0;
                
                let warningText = '';
                if (weatherData.weatherMain === 'Rain' || rainIntensity > 0) {
                    warningText = `🌧️ 비로 인한 지하철 지연 가능성 (강도: ${rainIntensity}mm/h)`;
                } else if (weatherData.weatherMain === 'Snow' || snowIntensity > 0) {
                    warningText = `❄️ 눈으로 인한 지하철 지연 가능성 (강도: ${snowIntensity}mm/h)`;
                } else if (weatherData.weatherMain === 'Drizzle') {
                    warningText = `🌦️ 이슬비로 인한 지하철 지연 가능성`;
                }
                
                warningBanner.innerHTML = `
                    <div class="rain-icon">⚠️</div>
                    <div class="rain-text">${warningText}</div>
                    <div class="rain-location">📍 ${weatherData.city}</div>
                `;
                warningBanner.style.display = 'flex';
                
                console.log('우천 경고 표시:', warningText);
            } else {
                if (warningBanner) {
                    warningBanner.style.display = 'none';
                    console.log('우천 경고 숨김 - 조건 미충족');
                }
            }
        }
        
        async function updateWeatherInfo() {
            try {
                console.log('🌤️ 날씨 정보 업데이트 시작');
                
                // 위치 기반 날씨 데이터 가져오기
                const locationWeatherData = await fetchLocationBasedWeather();
                
                if (locationWeatherData) {
                    console.log('✅ 날씨 데이터 받음:', locationWeatherData);
                    
                    // 날씨 아이콘 업데이트
                    const weatherIcon = document.getElementById('weather-icon');
                    const weatherTemp = document.getElementById('weather-temp');
                    const weatherDesc = document.getElementById('weather-desc');
                    
                    // 아이콘 매핑
                    const iconMap = {
                        '01d': '☀️', '01n': '🌙',
                        '02d': '⛅', '02n': '☁️',
                        '03d': '☁️', '03n': '☁️',
                        '04d': '☁️', '04n': '☁️',
                        '09d': '🌧️', '09n': '🌧️',
                        '10d': '🌦️', '10n': '🌧️',
                        '11d': '⛈️', '11n': '⛈️',
                        '13d': '❄️', '13n': '❄️',
                        '50d': '🌫️', '50n': '🌫️'
                    };
                    
                    if (weatherIcon) {
                        weatherIcon.textContent = iconMap[locationWeatherData.icon] || '🌤️';
                        console.log('🎨 날씨 아이콘 업데이트:', weatherIcon.textContent);
                    }
                    
                    if (weatherTemp) {
                        weatherTemp.textContent = `${locationWeatherData.temperature}°C`;
                        console.log('🌡️ 온도 업데이트:', weatherTemp.textContent);
                    }
                    
                    if (weatherDesc) {
                        weatherDesc.textContent = locationWeatherData.description;
                        console.log('📝 날씨 설명 업데이트:', weatherDesc.textContent);
                    }
                    
                    // 위치 기반 우천 경고 표시 (비/눈이 올 때만)
                    showRainWarning();
                } else {
                    console.log('❌ 날씨 데이터를 가져올 수 없습니다');
                    
                    // 기본값 표시
                    const weatherIcon = document.getElementById('weather-icon');
                    const weatherTemp = document.getElementById('weather-temp');
                    const weatherDesc = document.getElementById('weather-desc');
                    
                    if (weatherIcon) weatherIcon.textContent = '🌤️';
                    if (weatherTemp) weatherTemp.textContent = '--°C';
                    if (weatherDesc) weatherDesc.textContent = '날씨 정보 없음';
                    
                    // 우천 경고 숨기기
                    const warningBanner = document.getElementById('rain-warning');
                    if (warningBanner) {
                        warningBanner.style.display = 'none';
                        console.log('⚠️ 우천 경고 숨김 - 데이터 없음');
                    }
                }
                
                console.log('🌤️ 날씨 정보 업데이트 완료');
            } catch (error) {
                console.error('❌ 날씨 정보 업데이트 실패:', error);
                
                // 에러 시 기본값 표시
                const weatherIcon = document.getElementById('weather-icon');
                const weatherTemp = document.getElementById('weather-temp');
                const weatherDesc = document.getElementById('weather-desc');
                
                if (weatherIcon) weatherIcon.textContent = '🌤️';
                if (weatherTemp) weatherTemp.textContent = '--°C';
                if (weatherDesc) weatherDesc.textContent = '날씨 정보 오류';
                
                // 우천 경고 숨기기
                const warningBanner = document.getElementById('rain-warning');
                if (warningBanner) {
                    warningBanner.style.display = 'none';
                    console.log('⚠️ 우천 경고 숨김 - 에러 발생');
                }
            }
        }
        
        // 데이터 새로고침
        async function refreshData() {
            console.log('🔄 수동 데이터 새로고침 시작');
            const refreshBtn = event.target.closest('.quick-menu-btn');
            const originalText = refreshBtn.querySelector('.quick-menu-text').textContent;
            
            // 버튼 상태 변경
            refreshBtn.querySelector('.quick-menu-text').textContent = '새로고침 중...';
            refreshBtn.style.opacity = '0.6';
            
            try {
                await loadSubwayData();
                refreshBtn.querySelector('.quick-menu-text').textContent = '완료!';
                setTimeout(() => {
                    refreshBtn.querySelector('.quick-menu-text').textContent = originalText;
                    refreshBtn.style.opacity = '1';
                }, 2000);
            } catch (error) {
                console.error('새로고침 오류:', error);
                refreshBtn.querySelector('.quick-menu-text').textContent = '오류 발생';
                setTimeout(() => {
                    refreshBtn.querySelector('.quick-menu-text').textContent = originalText;
                    refreshBtn.style.opacity = '1';
                }, 2000);
            }
        }
        
        // 실시간 데이터 시뮬레이션
        async function loadSubwayData() {
            try {
                console.log('🚇 서울 지하철 실시간 데이터 시뮬레이션 시작');
                
                // 로딩 상태 표시
                showLoading();
                
                // 2초 대기 (실제 API 호출 시뮬레이션)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 실시간 시뮬레이션 데이터 생성
                const simulatedData = generateRealTimeData();
                
                // 시뮬레이션 데이터로 UI 업데이트
                updateUIWithSimulatedData(simulatedData);
                
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                updateUIWithSampleData();
            }
        }
        
        // 실시간 데이터 생성
        function generateRealTimeData() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // 시간대별 기본 혼잡도
            let baseCongestion = { smooth: 50, normal: 35, congested: 15 };
            
            // 출퇴근 시간대 혼잡도 증가
            if ((hour >= 7 && hour <= 9) || (hour >= 18 && hour <= 20)) {
                baseCongestion = { smooth: 25, normal: 45, congested: 30 };
            }
            // 점심시간 혼잡도 증가
            else if (hour >= 12 && hour <= 14) {
                baseCongestion = { smooth: 35, normal: 50, congested: 15 };
            }
            
            // 랜덤 변동 추가 (±5%)
            const variation = () => Math.floor(Math.random() * 10) - 5;
            const congestion = {
                smooth: Math.max(0, Math.min(100, baseCongestion.smooth + variation())),
                normal: Math.max(0, Math.min(100, baseCongestion.normal + variation())),
                congested: Math.max(0, Math.min(100, baseCongestion.congested + variation()))
            };
            
            // 노선별 상태 생성
            const lineStatus = {
                '1': generateLineStatus('1', hour),
                '2': generateLineStatus('2', hour),
                '3': generateLineStatus('3', hour),
                '4': generateLineStatus('4', hour),
                '5': generateLineStatus('5', hour),
                '6': generateLineStatus('6', hour),
                '7': generateLineStatus('7', hour),
                '8': generateLineStatus('8', hour),
                '9': generateLineStatus('9', hour)
            };
            
            return {
                congestion_stats: congestion,
                line_status: lineStatus,
                stations: 338,
                passenger_data: Math.floor(Math.random() * 200) + 300,
                timestamp: now.toISOString()
            };
        }
        
        // 노선별 상태 생성
        function generateLineStatus(lineNum, hour) {
            const lineNames = {
                '1': '서울역 ↔ 청량리',
                '2': '성수 ↔ 신정네거리',
                '3': '대화 ↔ 수서',
                '4': '당고개 ↔ 오이도',
                '5': '방화 ↔ 마천',
                '6': '응암순환선',
                '7': '장암 ↔ 부평구청',
                '8': '암사 ↔ 모란',
                '9': '개화 ↔ 중앙보훈병원'
            };
            
            // 시간대별 기본 상태 (경로 검색과 동일한 기준 사용)
            let baseStatus = 'smooth';
            let description = '정상 운행 중';
            
            // 러시아워 시간대 (7-9시, 18-20시) - 혼잡
            if ((hour >= 7 && hour <= 9) || (hour >= 18 && hour <= 20)) {
                if (lineNum === '2' || lineNum === '3' || lineNum === '9') {
                    baseStatus = 'congested';
                    description = `${lineNames[lineNum]} 구간 심한 지연`;
                } else if (lineNum === '1' || lineNum === '5' || lineNum === '7') {
                    baseStatus = 'congested';
                    description = `${lineNames[lineNum]} 구간 지연`;
                } else {
                    baseStatus = 'normal';
                    description = `${lineNames[lineNum]} 구간 지연`;
                }
            }
            // 오전/오후 시간대 (9-11시, 14-16시) - 보통
            else if ((hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16)) {
                if (lineNum === '2' || lineNum === '3' || lineNum === '9') {
                    baseStatus = 'normal';
                    description = `${lineNames[lineNum]} 구간 지연`;
                } else {
                    baseStatus = 'smooth';
                    description = '정상 운행 중';
                }
            }
            // 점심시간 (11-14시) - 보통
            else if (hour >= 11 && hour <= 14) {
                if (lineNum === '3' || lineNum === '9') {
                    baseStatus = 'normal';
                    description = `${lineNames[lineNum]} 구간 지연`;
                } else {
                    baseStatus = 'smooth';
                    description = '정상 운행 중';
                }
            }
            // 저녁/야간 (20-23시) - 보통
            else if (hour >= 20 && hour <= 23) {
                if (lineNum === '2' || lineNum === '3') {
                    baseStatus = 'normal';
                    description = `${lineNames[lineNum]} 구간 지연`;
                } else {
                    baseStatus = 'smooth';
                    description = '정상 운행 중';
                }
            }
            // 심야/새벽 (23-7시) - 원활
            else {
                baseStatus = 'smooth';
                description = '정상 운행 중';
            }
            
            // 랜덤 이벤트 (10% 확률)
            if (Math.random() < 0.1) {
                const events = [
                    { status: 'congested', description: `${lineNames[lineNum]} 구간 심한 지연` },
                    { status: 'normal', description: `${lineNames[lineNum]} 구간 지연` },
                    { status: 'smooth', description: '정상 운행 중' }
                ];
                const event = events[Math.floor(Math.random() * events.length)];
                baseStatus = event.status;
                description = event.description;
            }
            
            const statusTexts = {
                'smooth': '원할',
                'normal': '보통',
                'congested': '혼잡'
            };
            
            return {
                status: baseStatus,
                status_text: statusTexts[baseStatus],
                description: description,
                avg_passengers: Math.floor(Math.random() * 20000) + 15000
            };
        }
        
        // 로딩 상태 표시
        function showLoading() {
            document.getElementById('congestion-cards').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
            
            document.getElementById('lines-container').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
            
            document.getElementById('update-time').textContent = '데이터 로딩 중...';
            document.getElementById('update-message').textContent = '서울 지하철 실시간 데이터를 수집하고 있습니다';
        }
        
        // 실제 데이터로 UI 업데이트
        function updateUIWithRealData(stations, passengers) {
            console.log('실제 데이터로 UI 업데이트');
            
            // 혼잡도 통계 계산
            const congestionStats = calculateCongestionStats(passengers);
            
            // 혼잡도 카드 업데이트
            document.getElementById('congestion-cards').innerHTML = `
                <div class="congestion-card">
                    <div class="congestion-circle circle-smooth">${congestionStats.smooth}%</div>
                    <div class="congestion-label">원할</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-normal">${congestionStats.normal}%</div>
                    <div class="congestion-label">보통</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-congested">${congestionStats.congested}%</div>
                    <div class="congestion-label">혼잡</div>
                </div>
            `;
            
            // 노선별 상태 계산
            const lineStatus = calculateLineStatus(passengers);
            
            // 노선별 현황 업데이트
            updateLineCards(lineStatus);
            
            // 최근 업데이트 시간 업데이트
            const now = new Date();
            document.getElementById('update-time').textContent = `${now.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})} 업데이트`;
            document.getElementById('update-message').textContent = `${stations.length}개 역, ${passengers.length}개 승하차 데이터 수집 완료`;
            
            console.log(`✅ 실제 데이터로 UI 업데이트 완료 - 역: ${stations.length}개, 승하차: ${passengers.length}개`);
        }
        
        // 시뮬레이션 데이터로 UI 업데이트
        function updateUIWithSimulatedData(data) {
            console.log('🔄 실시간 시뮬레이션 데이터로 UI 업데이트');
            
            // 혼잡도 카드 업데이트
            document.getElementById('congestion-cards').innerHTML = `
                <div class="congestion-card">
                    <div class="congestion-circle circle-smooth">${data.congestion_stats.smooth}%</div>
                    <div class="congestion-label">원할</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-normal">${data.congestion_stats.normal}%</div>
                    <div class="congestion-label">보통</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-congested">${data.congestion_stats.congested}%</div>
                    <div class="congestion-label">혼잡</div>
                </div>
            `;
            
            // 노선별 현황 업데이트
            updateLineCards(data.line_status);
            
            // 최근 업데이트 시간 업데이트
            const updateTime = new Date(data.timestamp);
            document.getElementById('update-time').textContent = `${updateTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})} 실시간 업데이트`;
            document.getElementById('update-message').textContent = `서울 지하철 ${data.stations}개 역, ${data.passenger_data}개 데이터 수집 완료`;
            
            console.log(`✅ 실시간 시뮬레이션 업데이트 완료 - 역: ${data.stations}개, 데이터: ${data.passenger_data}개`);
        }
        
        // 샘플 데이터로 UI 업데이트
        function updateUIWithSampleData() {
            console.log('샘플 데이터로 UI 업데이트');
            
            // 혼잡도 카드 업데이트
            document.getElementById('congestion-cards').innerHTML = `
                <div class="congestion-card">
                    <div class="congestion-circle circle-smooth">${sampleData.congestion_stats.smooth}%</div>
                    <div class="congestion-label">원할</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-normal">${sampleData.congestion_stats.normal}%</div>
                    <div class="congestion-label">보통</div>
                </div>
                <div class="congestion-card">
                    <div class="congestion-circle circle-congested">${sampleData.congestion_stats.congested}%</div>
                    <div class="congestion-label">혼잡</div>
                </div>
            `;
            
            // 노선별 현황 업데이트
            updateLineCards(sampleData.line_status);
            
            // 업데이트 시간 표시
            const now = new Date();
            document.getElementById('update-time').textContent = `${now.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})} (샘플 데이터)`;
            document.getElementById('update-message').textContent = '3호선 강남역 승강장 혼잡도 증가';
            
            console.log('✅ 샘플 데이터로 UI 업데이트 완료');
        }
        
        // 혼잡도 통계 계산
        function calculateCongestionStats(passengerData) {
            if (!passengerData || passengerData.length === 0) {
                return { smooth: 42, normal: 35, congested: 23 };
            }
            
            const counts = { smooth: 0, normal: 0, congested: 0 };
            
            passengerData.forEach(data => {
                const rideCount = parseInt(data.RIDE_PASGR_NUM || 0);
                const alightCount = parseInt(data.ALIGHT_PASGR_NUM || 0);
                const totalCount = rideCount + alightCount;
                
                if (totalCount < 20000) {
                    counts.smooth++;
                } else if (totalCount < 35000) {
                    counts.normal++;
                } else {
                    counts.congested++;
                }
            });
            
            const total = counts.smooth + counts.normal + counts.congested;
            if (total > 0) {
                return {
                    smooth: Math.round(counts.smooth / total * 100),
                    normal: Math.round(counts.normal / total * 100),
                    congested: Math.round(counts.congested / total * 100)
                };
            }
            
            return { smooth: 42, normal: 35, congested: 23 };
        }
        
        // 노선별 상태 계산
        function calculateLineStatus(passengerData) {
            const lineStats = {};
            
            passengerData.forEach(data => {
                const lineNum = data.LINE_NUM;
                if (lineNum) {
                    const rideCount = parseInt(data.RIDE_PASGR_NUM || 0);
                    const alightCount = parseInt(data.ALIGHT_PASGR_NUM || 0);
                    const totalCount = rideCount + alightCount;
                    
                    if (!lineStats[lineNum]) {
                        lineStats[lineNum] = { total: 0, count: 0 };
                    }
                    
                    lineStats[lineNum].total += totalCount;
                    lineStats[lineNum].count++;
                }
            });
            
            const result = {};
            Object.keys(lineStats).forEach(lineNum => {
                const stats = lineStats[lineNum];
                if (stats.count > 0) {
                    const avgPassengers = stats.total / stats.count;
                    
                    let status, statusText, description;
                    if (avgPassengers < 20000) {
                        status = 'smooth';
                        statusText = '원할';
                        description = '정상 운행 중';
                    } else if (avgPassengers < 35000) {
                        status = 'normal';
                        statusText = '보통';
                        description = '일부 구간 지연';
                    } else {
                        status = 'congested';
                        statusText = '혼잡';
                        description = '심한 지연';
                    }
                    
                    result[lineNum] = {
                        status: status,
                        status_text: statusText,
                        description: description,
                        avg_passengers: avgPassengers
                    };
                }
            });
            
            return result;
        }
        
        // 노선 카드 업데이트
        function updateLineCards(lineStatus) {
            const linesContainer = document.getElementById('lines-container');
            linesContainer.innerHTML = '';
            
            // 모든 노선들 (1-9호선)
            const defaultLines = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
            
            defaultLines.forEach(lineNum => {
                const lineData = lineStatus[lineNum] || sampleData.line_status[lineNum];
                const lineCard = document.createElement('div');
                lineCard.className = 'line-card';
                
                lineCard.innerHTML = `
                    <div class="line-info">
                        <div class="line-number line-${lineNum}">${lineNum}</div>
                        <div class="line-details">
                            <h3>${lineNum}호선</h3>
                            <p>${lineData.description}</p>
                        </div>
                    </div>
                    <div class="line-status">
                        <div class="status-dot status-${lineData.status}"></div>
                        <span class="status-text">${lineData.status_text}</span>
                    </div>
                `;
                
                linesContainer.appendChild(lineCard);
            });
        }
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('교통 현황 대시보드 로드 완료');
            
            // 초기 데이터 로드
            loadSubwayData();
            
            // 초기 날씨 정보 로드
            updateWeatherInfo();
            
            // 사용자 정보 확인
            const user = JSON.parse(localStorage.getItem('user'));
            updateUserUI(user);
            
            // 30초마다 데이터 업데이트 (더 자주 변경)
            setInterval(loadSubwayData, 30000);
            
            // 10분마다 날씨 정보 업데이트
            setInterval(updateWeatherInfo, 600000);
            
            // 마케팅 배너 체크
            checkCongestionAndShowBanner();
        });
        
        // 마케팅 관련 함수들
        function showCongestionBanner() {
            const banner = document.getElementById('congestion-banner');
            if (banner) {
                banner.style.display = 'block';
                console.log('혼잡 시간대 할인 배너 표시');
            }
        }
        
        function closeMarketingBanner(bannerId) {
            const banner = document.getElementById(bannerId);
            if (banner) {
                banner.style.display = 'none';
                console.log('마케팅 배너 닫기:', bannerId);
            }
        }
        
        function useCoupon(couponCode) {
            console.log('쿠폰 사용:', couponCode);
            showToast(`쿠폰 ${couponCode}이 적용되었습니다!`, 'success');
            
            // 쿠폰 사용 기록 저장
            const usedCoupons = JSON.parse(localStorage.getItem('usedCoupons') || '[]');
            usedCoupons.push({
                code: couponCode,
                usedAt: new Date().toLocaleString('ko-KR'),
                discount: '20%'
            });
            localStorage.setItem('usedCoupons', JSON.stringify(usedCoupons));
        }
        
        function showNearbyCafes() {
            const cafes = [
                { name: '스타벅스 강남점', distance: '200m', discount: '20%' },
                { name: '투썸플레이스', distance: '300m', discount: '15%' },
                { name: '이디야커피', distance: '150m', discount: '25%' }
            ];
            
            let message = '☕ 근처 카페 정보:<br><br>';
            cafes.forEach(cafe => {
                message += `• ${cafe.name} (${cafe.distance})<br>  할인: ${cafe.discount}<br><br>`;
            });
            
            showModal('근처 카페 할인 정보', message);
        }
        
        function showAlternativeTransport() {
            const alternatives = [
                { type: '버스', time: '5분', cost: '1,200원', route: '146번' },
                { type: '택시', time: '8분', cost: '3,500원', route: '직행' },
                { type: '카셰어링', time: '3분', cost: '2,800원', route: '쏘카' }
            ];
            
            let message = '🚌 대안 교통수단:<br><br>';
            alternatives.forEach(alt => {
                message += `• ${alt.type}<br>  소요시간: ${alt.time}<br>  요금: ${alt.cost}<br>  경로: ${alt.route}<br><br>`;
            });
            
            showModal('대안 교통수단', message);
        }
        
        function showNearbyShopping() {
            const shops = [
                { name: '롯데백화점', distance: '500m', discount: '10%' },
                { name: '현대백화점', distance: '600m', discount: '15%' },
                { name: '강남역 지하상가', distance: '100m', discount: '5%' }
            ];
            
            let message = '🛍️ 역세권 쇼핑 정보:<br><br>';
            shops.forEach(shop => {
                message += `• ${shop.name} (${shop.distance})<br>  할인: ${shop.discount}<br><br>`;
            });
            
            showModal('쇼핑 정보', message);
        }
        
        function showNearbyRestaurants() {
            const restaurants = [
                { name: '맛있는 식당', cuisine: '한식', rating: '4.5', distance: '200m' },
                { name: '이탈리안 레스토랑', cuisine: '양식', rating: '4.3', distance: '300m' },
                { name: '일본 라멘집', cuisine: '일식', rating: '4.7', distance: '150m' }
            ];
            
            let message = '🍽️ 근처 맛집 추천:<br><br>';
            restaurants.forEach(restaurant => {
                message += `• ${restaurant.name}<br>  종류: ${restaurant.cuisine}<br>  평점: ${restaurant.rating}⭐<br>  거리: ${restaurant.distance}<br><br>`;
            });
            
            showModal('맛집 추천', message);
        }
        
        // 혼잡도에 따른 마케팅 배너 표시
        function checkCongestionAndShowBanner() {
            const currentHour = new Date().getHours();
            const isRushHour = (currentHour >= 7 && currentHour <= 9) || (currentHour >= 18 && currentHour <= 20);
            
            if (isRushHour) {
                // 랜덤하게 배너 표시 (30% 확률)
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        showCongestionBanner();
                    }, 5000); // 5초 후 표시
                }
            }
        }
    </script>
</body>
</html>
